<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<script>
const CONTRACT_PRESALE = "ISI_CONTRACT_PRESALE_KAMU";
const PRESALE_TOTAL = ethers.utils.parseUnits("5000000",18);

let provider;
let signer;
let presale;

const presaleABI = [
"function buy(uint256 amount) external",
"function tokensSold() view returns(uint256)"
];

async function connectWallet(){

    if(!window.ethereum){
        alert("Install Metamask / OKX Wallet Browser");
        return;
    }

    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();

    presale = new ethers.Contract(CONTRACT_PRESALE, presaleABI, signer);

    loadProgress();
}

async function loadProgress(){
    const sold = await presale.tokensSold();
    const remaining = PRESALE_TOTAL.sub(sold);

    document.getElementById("remaining").innerText =
        ethers.utils.formatUnits(remaining,18)+" BMR";

    const percent = sold.mul(100).div(PRESALE_TOTAL);
    document.getElementById("progressBar").style.width =
        percent.toString()+"%";
}

async function buy(){
    const amount = document.getElementById("buyAmount").value;
    if(!amount) return alert("Enter amount");

    const tx = await presale.buy(
        ethers.utils.parseUnits(amount,18)
    );

    await tx.wait();
    alert("Purchase Success!");
    loadProgress();
}
</script>
